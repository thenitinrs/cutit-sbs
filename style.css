// Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDk5GSy3y0g9iO6S6mzcr-MoZ-mGNJojOI",
  authDomain: "cutit-74ff4.firebaseapp.com",
  projectId: "cutit-74ff4",
  storageBucket: "cutit-74ff4.appspot.com",
  messagingSenderId: "665495125746",
  appId: "1:665495125746:web:eb6dc0d361ab485fe25a6b",
  measurementId: "G-WC70F5PK7P"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM elements
const input = document.getElementById("urlInput");
const outputBox = document.getElementById("output");
const shortenBtn = document.getElementById("finalShorten");
const qrBtn = document.getElementById("qrBtn");

const clearOutput = () => (outputBox.innerHTML = "");

const showQR = (url) => {
  QRCode.toDataURL(url, { margin: 1 }, (err, dataUrl) => {
    if (err) return console.error(err);
    outputBox.innerHTML += `
      <img src="${dataUrl}" alt="QR code" style="margin-top:1rem;width:160px;border-radius:8px;box-shadow:0 0 8px var(--accent);" />
    `;
  });
};

shortenBtn.onclick = async () => {
  clearOutput();
  const longUrl = input.value.trim();
  if (!longUrl) return alert("Paste something first!");

  try {
    const code = Math.random().toString(36).slice(2, 8);
    await addDoc(collection(db, "links"), {
      code,
      longUrl,
      createdAt: Date.now()
    });

    const shortUrl = `https://cutit.sbs/l/${code}`;
    outputBox.innerHTML = `ðŸ”— <a href="${shortUrl}" target="_blank">${shortUrl}</a>`;
    showQR(shortUrl);
  } catch (e) {
    console.error(e);
    alert("Error! Firestore hiccup?");
  }
};

qrBtn.onclick = () => {
  clearOutput();
  const rawUrl = input.value.trim();
  if (!rawUrl) return alert("Paste a URL first!");
  outputBox.innerHTML = `ðŸŽ¯ QR for:<br><a href="${rawUrl}" target="_blank">${rawUrl}</a>`;
  showQR(rawUrl);
};

document.getElementById("customBtn").onclick = () =>
  window.location.href = "https://rzp.io/l/custom-url-cutit";
